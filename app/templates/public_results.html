<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Results - CC6</title>
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .filters { margin: 20px 0; display: flex; flex-direction: column; gap: 20px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-weight: bold; }
        .checkboxes { display: flex; gap: 15px; flex-wrap: wrap; justify-content: flex-start; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; min-width: fit-content; padding: 5px 0; }
        .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] { margin: 0; flex-shrink: 0; width: 16px; height: 16px; }
        .checkbox-group label { margin: 0; white-space: nowrap; cursor: pointer; font-size: 14px; line-height: 1.2; }
        @media (max-width: 768px) {
            .checkboxes { flex-direction: column; gap: 10px; }
            .checkbox-group { justify-content: flex-start; }
        }
        select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); }
        button { padding: 10px 20px; background: var(--button-bg); color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: var(--button-hover-bg); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .results-container { margin-top: 20px; background-color: var(--bg-color); color: var(--text-color); }
        .race-info { margin-bottom: 20px; padding: 15px; background: var(--table-header-bg); border-radius: 4px; color: var(--text-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--table-header-bg); font-weight: bold; color: var(--text-color); }
        .loading { text-align: center; padding: 20px; color: var(--text-color); }
        .error { color: var(--error-text); padding: 10px; background: var(--error-bg); border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <img src="{{ url_for('static', filename='cc6-slogan-black.png') }}" alt="CC6 Logo" class="logo">
    
    {% include 'public_nav.html' %}
    
    <h1>Race Results</h1>
    
    <div class="filters">
        <div class="filter-group">
            <label for="seasonSelect">Season:</label>
            <select id="seasonSelect">
                <option value="">Select Season</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="raceSelect">Race:</label>
            <select id="raceSelect" disabled>
                <option value="">Select Race</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Category:</label>
            <div class="checkboxes" id="categoryFilters">
                <div class="checkbox-group">
                    <input type="radio" id="catAll" name="category" value="">
                    <label for="catAll">All</label>
                </div>
            </div>
        </div>
        <div class="filter-group">
            <label>Gender:</label>
            <div class="checkboxes">
                <div class="checkbox-group">
                    <input type="radio" id="genderAll" name="gender" value="">
                    <label for="genderAll">All</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="genderMale" name="gender" value="Male">
                    <label for="genderMale">Male</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="genderFemale" name="gender" value="Female">
                    <label for="genderFemale">Female</label>
                </div>
            </div>
        </div>
        <div class="filter-group">
            <label>Options:</label>
            <div class="checkboxes">
                <div class="checkbox-group">
                    <input type="checkbox" id="showMissing" value="showMissingData">
                    <label for="showMissing">Include participants with missing data</label>
                </div>
            </div>
        </div>
        <button id="loadResults" disabled>Load Results</button>
    </div>
    
    <div id="resultsContainer" class="results-container"></div>
    
    <script>
        let seasons = [];
        let currentRaces = [];
        
        // Load seasons on page load
        async function loadSeasons() {
            try {
                const response = await fetch('/api/seasons');
                const data = await response.json();
                seasons = data.seasons;
                
                const seasonSelect = document.getElementById('seasonSelect');
                seasonSelect.innerHTML = '<option value="">Select Season</option>';
                
                // Check for URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const selectedSeason = urlParams.get('season') || data.default_season;
                const selectedRace = urlParams.get('race');
                
                seasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season;
                    option.textContent = season;
                    if (season === selectedSeason) {
                        option.selected = true;
                    }
                    seasonSelect.appendChild(option);
                });
                
                // Auto-load races if season is selected
                if (selectedSeason) {
                    await loadRaces(selectedSeason);
                    
                    // Auto-select race if specified in URL
                    if (selectedRace) {
                        const raceSelect = document.getElementById('raceSelect');
                        raceSelect.value = selectedRace;
                        document.getElementById('loadResults').disabled = false;
                        loadResults();
                    } else if (data.default_race && selectedSeason === data.default_season) {
                        const raceSelect = document.getElementById('raceSelect');
                        raceSelect.value = data.default_race;
                        document.getElementById('loadResults').disabled = false;
                        loadResults();
                    }
                }
            } catch (error) {
                console.error('Error loading seasons:', error);
            }
        }
        
        // Load races when season changes
        async function loadRaces(seasonId) {
            try {
                const response = await fetch(`/api/seasons/${seasonId}`);
                const seasonData = await response.json();
                currentRaces = seasonData.races || [];
                
                const raceSelect = document.getElementById('raceSelect');
                raceSelect.innerHTML = '<option value="">Select Race</option>';
                
                currentRaces.forEach(race => {
                    const option = document.createElement('option');
                    option.value = race.name;
                    option.textContent = `${race.name} (${race.date})`;
                    raceSelect.appendChild(option);
                });
                
                raceSelect.disabled = false;
                document.getElementById('loadResults').disabled = true;
                
                // Update category filters based on season
                const categorySize = seasonData.age_category_size || 5;
                const categories = generateAgeCategories(categorySize);
                updateCategoryFilters(categories);
            } catch (error) {
                console.error('Error loading races:', error);
            }
        }
        
        // Load and display results
        async function loadResults() {
            const raceId = document.getElementById('raceSelect').value;
            if (!raceId) return;
            
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="loading">Loading results...</div>';
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                
                if (document.getElementById('showMissing').checked) {
                    params.append('showMissingData', 'true');
                }
                
                const category = document.querySelector('input[name="category"]:checked')?.value;
                if (category) {
                    params.append('category', category);
                }
                
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                if (gender) {
                    params.append('gender', gender);
                }
                
                const queryString = params.toString();
                const seasonId = document.getElementById('seasonSelect').value;
                const url = `/api/races/${seasonId}/${raceId}${queryString ? '?' + queryString : ''}`;
                
                const response = await fetch(url);
                const raceData = await response.json();
                
                if (response.ok) {
                    displayResults(raceData);
                } else {
                    container.innerHTML = `<div class="error">Error: ${raceData.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading results: ${error.message}</div>`;
            }
        }
        
        // Display results in table
        function displayResults(raceData) {
            const container = document.getElementById('resultsContainer');
            
            // Get race date from currentRaces array
            const selectedRace = currentRaces.find(race => race.name === raceData.name);
            const raceDate = selectedRace ? selectedRace.date : 'Unknown';
            
            let html = `
                <div class="race-info">
                    <h2>${raceData.name}</h2>
                    <p><strong>Date:</strong> ${raceDate}</p>
                    <p><strong>Season:</strong> ${raceData.season}</p>
                    <p><strong>Results:</strong> ${raceData.results.length} participants</p>
                </div>
            `;
            
            if (raceData.results.length > 0) {
                html += `
                    <table>
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Position Token</th>
                                <th>Name</th>
                                <th>Gender</th>
                                <th>Category</th>
                                <th>Club</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                raceData.results.forEach((result, index) => {
                    const participant = result.participant || {};
                    const participantName = participant.first_name && participant.last_name ? participant.first_name + ' ' + participant.last_name : '-';
                    const nameCell = participant.parkrun_barcode_id ? `<a href="/participant/${participant.parkrun_barcode_id}" style="color: #007bff; text-decoration: none;">${participantName}</a>` : participantName;
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${result.finish_token}</td>
                            <td>${nameCell}</td>
                            <td>${participant.gender || '-'}</td>
                            <td>${participant.age_category || '-'}</td>
                            <td>${participant.club || '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No results found for the selected filters.</p>';
            }
            
            container.innerHTML = html;
        }
        
        // Event listeners
        document.getElementById('seasonSelect').addEventListener('change', function() {
            const seasonId = this.value;
            if (seasonId) {
                loadRaces(seasonId);
            } else {
                document.getElementById('raceSelect').innerHTML = '<option value="">Select Race</option>';
                document.getElementById('raceSelect').disabled = true;
                document.getElementById('loadResults').disabled = true;
                document.getElementById('resultsContainer').innerHTML = '';
            }
        });
        
        document.getElementById('raceSelect').addEventListener('change', function() {
            document.getElementById('loadResults').disabled = !this.value;
        });
        
        document.getElementById('loadResults').addEventListener('click', loadResults);
        
        // Generate age categories based on size
        function generateAgeCategories(size) {
            const categories = ['Senior'];
            for (let age = 40; age <= 80; age += size) {
                categories.push(`V${age}`);
            }
            return categories;
        }
        
        // Update category filters
        function updateCategoryFilters(categories) {
            const container = document.getElementById('categoryFilters');
            container.innerHTML = '<div class="checkbox-group"><input type="radio" id="catAll" name="category" value="" checked><label for="catAll">All</label></div>';
            
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.innerHTML = `
                    <input type="radio" id="cat${category}" name="category" value="${category}">
                    <label for="cat${category}">${category}</label>
                `;
                container.appendChild(div);
            });
        }
        
        // Set default radio button selections
        document.getElementById('genderAll').checked = true;
        
        // Load seasons on page load
        loadSeasons();
    </script>
    
    {% include 'footer.html' %}
</body>
</html>