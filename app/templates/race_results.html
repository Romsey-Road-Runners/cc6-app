<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Results - {{ race_name }}</title>
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { max-width: 1000px; }
        th, td { border-bottom: 1px solid #ddd; }
        .delete-btn { color: red; cursor: pointer; }
        .arrow-btn { background: none; border: none; cursor: pointer; font-size: 16px; color: #007bff; padding: 2px 4px; }
        .missing-position, .duplicate-position { background-color: #ffcccc; }
        .flash-messages { margin: 20px 0; }
        .flash-message { padding: 10px; margin: 5px 0; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; }
    </style>
</head>
<body>
    <img src="{{ url_for('static', filename='cc6-slogan-black.png') }}" alt="CC6 Logo" class="logo">
    
    {% include 'nav.html' %}

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="flash-message">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <h1>{{ season }}</h1>
    <h2>{{ race_name }}</h2>
    <h3>{{ race_date }}</h3>
    
    <div style="margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
        <div>
            <h4>Upload CSV Results</h4>
            <form method="POST" action="{{ url_for('process_upload_results') }}" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: end;">
                <input type="hidden" name="season_name" value="{{ season }}">
                <input type="hidden" name="race_name" value="{{ race_name }}">
                <div>
                    <label for="file">CSV File:</label><br>
                    <input type="file" name="file" accept=".csv" required>
                </div>
                <button type="submit">Upload</button>
            </form>
        </div>
        
        <div>
            <h4>Add Manual Result</h4>
            <form method="POST" action="{{ url_for('add_manual_result') }}" style="display: flex; gap: 10px; align-items: end;">
                <input type="hidden" name="season_name" value="{{ season }}">
                <input type="hidden" name="race_name" value="{{ race_name }}">
                <div>
                    <label for="participant_search">Participant:</label><br>
                    <input type="text" id="participant_search" placeholder="Search by name or Parkrun ID" required>
                    <input type="hidden" name="barcode" id="selected_barcode">
                    <div id="search_results" style="position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; display: none; z-index: 1000;"></div>
                </div>
                <div>
                    <label for="position_token">Position Token:</label><br>
                    <input type="text" name="position_token" placeholder="P0001" required>
                </div>
                <button type="submit">Add Result</button>
            </form>
        </div>
        
        <div>
            <form method="POST" action="{{ url_for('delete_all_race_results', season_name=season, race_name=race_name) }}">
                <h4>Danger Zone</h4>
                <button type="submit" onclick="return confirm('Delete ALL results for this race? This cannot be undone!')" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; cursor: pointer;">Delete All Results</button>
            </form>
        </div>
    </div>
    
    <div style="margin-bottom: 10px;">
        <label>
            <input type="checkbox" id="showMissingOnly" onchange="filterResults()">
            Show only rows with missing participant names
        </label>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Position Token</th>
                <th>Parkrun ID</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Category</th>
                <th>Club</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr data-id="{{ result.finish_token }}">
                <td>{{ result.finish_token }}</td>
                <td>{{ result.participant.parkrun_barcode_id or '-' }}</td>
                <td>{{ (result.participant.first_name + ' ' + result.participant.last_name) if result.participant.first_name else '-' }}</td>
                <td>{{ result.participant.gender or '-' }}</td>
                <td>{{ result.participant.age_category or '-' }}</td>
                <td>{{ result.participant.club or '-' }}</td>
                <td>
                    <button class="arrow-btn" onclick="moveResult('{{ result.finish_token }}', 'up')" title="Move up">↑</button>
                    <button class="arrow-btn" onclick="moveResult('{{ result.finish_token }}', 'down')" title="Move down">↓</button>
                    <form method="POST" action="{{ url_for('delete_race_result', season_name=season, race_name=race_name, finish_token=result.finish_token) }}" style="display: inline;">
                        <button type="submit" class="delete-btn" onclick="return confirm('Delete this result?')">×</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">No results found for this race.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        function moveResult(resultId, direction) {
            if (!confirm('Move this result ' + direction + '?')) {
                return;
            }
            
            const rows = Array.from(document.querySelectorAll('tbody tr[data-id]'));
            const currentRow = rows.find(row => row.dataset.id === resultId);
            const currentIndex = rows.indexOf(currentRow);
            
            let newIndex;
            if (direction === 'up' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < rows.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                return;
            }
            
            const tbody = currentRow.parentNode;
            const targetRow = rows[newIndex];
            
            if (direction === 'up') {
                tbody.insertBefore(currentRow, targetRow);
            } else {
                tbody.insertBefore(currentRow, targetRow.nextSibling);
            }
            
            updatePositions();
        }
        
        function updatePositions() {
            const rows = document.querySelectorAll('tbody tr[data-id]');
            const updates = [];
            
            rows.forEach((row, index) => {
                const id = row.dataset.id;
                const position = index + 1;
                row.children[0].textContent = `P${position.toString().padStart(4, '0')}`;
                updates.push({ id: id, position: position });
            });
            
            fetch('/reorder_race_results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            highlightIssues();
        }
        
        function highlightIssues() {
            const rows = document.querySelectorAll('tbody tr[data-id]');
            const positions = [];
            const positionCounts = {};
            
            // Collect positions and count duplicates
            rows.forEach(row => {
                const positionText = row.children[0].textContent;
                const positionNum = parseInt(positionText.replace('P', ''));
                positions.push(positionNum);
                positionCounts[positionNum] = (positionCounts[positionNum] || 0) + 1;
            });
            
            // Clear existing highlights
            rows.forEach(row => {
                row.classList.remove('missing-position', 'duplicate-position');
            });
            
            // Highlight duplicates
            rows.forEach(row => {
                const positionText = row.children[0].textContent;
                const positionNum = parseInt(positionText.replace('P', ''));
                if (positionCounts[positionNum] > 1) {
                    row.classList.add('duplicate-position');
                }
            });
            
            // Add missing position rows
            const tbody = document.querySelector('tbody');
            const existingMissing = tbody.querySelectorAll('.missing-position');
            existingMissing.forEach(row => row.remove());
            
            if (positions.length > 0) {
                const maxPosition = Math.max(...positions);
                for (let i = 1; i <= maxPosition; i++) {
                    if (!positions.includes(i)) {
                        const missingRow = document.createElement('tr');
                        missingRow.className = 'missing-position';
                        missingRow.innerHTML = `
                            <td>P${i.toString().padStart(4, '0')}</td>
                            <td colspan="6">Missing position</td>
                        `;
                        
                        // Insert in correct position
                        let inserted = false;
                        for (let row of tbody.children) {
                            if (row.dataset.id) {
                                const rowPos = parseInt(row.children[0].textContent.replace('P', ''));
                                if (i < rowPos) {
                                    tbody.insertBefore(missingRow, row);
                                    inserted = true;
                                    break;
                                }
                            }
                        }
                        if (!inserted) {
                            tbody.appendChild(missingRow);
                        }
                    }
                }
            }
        }
        
        // Initial highlight check
        document.addEventListener('DOMContentLoaded', highlightIssues);
        
        // Participant search functionality
        let participants = [];
        
        // Load participants
        fetch('/api/participants')
            .then(response => response.json())
            .then(data => {
                participants = data;
            })
            .catch(error => console.error('Error loading participants:', error));
        
        const searchInput = document.getElementById('participant_search');
        const searchResults = document.getElementById('search_results');
        const selectedBarcode = document.getElementById('selected_barcode');
        
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            const filtered = participants.filter(p => 
                p.first_name.toLowerCase().includes(query) ||
                p.last_name.toLowerCase().includes(query) ||
                p.barcode.toLowerCase().includes(query)
            ).slice(0, 10);
            
            if (filtered.length > 0) {
                searchResults.innerHTML = filtered.map(p => 
                    `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectParticipant('${p.barcode}', '${p.first_name} ${p.last_name} (${p.barcode})')">
                        ${p.first_name} ${p.last_name} (${p.barcode})
                    </div>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        });
        
        function selectParticipant(barcode, displayName) {
            searchInput.value = displayName;
            selectedBarcode.value = barcode;
            searchResults.style.display = 'none';
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
        
        function filterResults() {
            const showMissingOnly = document.getElementById('showMissingOnly').checked;
            const rows = document.querySelectorAll('tbody tr[data-id]');
            
            rows.forEach(row => {
                const nameCell = row.children[2]; // Name column
                const hasName = nameCell.textContent.trim() !== '-' && nameCell.textContent.trim() !== '';
                
                if (showMissingOnly) {
                    row.style.display = hasName ? 'none' : '';
                } else {
                    row.style.display = '';
                }
            });
        }
    </script>
</body>
</html>